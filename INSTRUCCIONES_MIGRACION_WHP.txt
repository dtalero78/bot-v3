â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  MIGRACIÃ“N WHP: De Wix a PostgreSQL - INSTRUCCIONES COMPLETAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ RESUMEN:
-----------
Migrar 34,000 registros de la colecciÃ³n WHP de Wix a PostgreSQL
para sincronizar el estado stopBot de conversaciones WhatsApp.

ğŸ“ ARCHIVOS CREADOS:
--------------------
âœ… /Users/danieltalero/BOTV3/bot-v3/migracion-whp.js
   â†’ Script de migraciÃ³n (listo para usar)

âœ… /Users/danieltalero/BOTV3/bot-v3/MIGRACION_WHP.md
   â†’ DocumentaciÃ³n completa de la migraciÃ³n

âœ… /Users/danieltalero/BOTV3/bot-v3/INSTRUCCIONES_MIGRACION_WHP.txt
   â†’ Este archivo (guÃ­a rÃ¡pida)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  PASO 1: CREAR ENDPOINT EN WIX
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âš ï¸ CRÃTICO: Debes agregar cÃ³digo a tu proyecto Wix antes de ejecutar
           la migraciÃ³n.

Archivos a modificar en Wix:
-----------------------------

1ï¸âƒ£ backend/exposeDataBase.js
   â†’ Agrega la funciÃ³n exportarWHP()

2ï¸âƒ£ backend/http-functions.js
   â†’ Agrega el endpoint get_exportarWHP()

ğŸ’¡ El cÃ³digo completo estÃ¡ en: MIGRACION_WHP.md (secciÃ³n "CÃ³digo a Agregar en Wix")

ğŸ“ CÃ“DIGO RESUMIDO PARA WIX:
----------------------------

// En backend/exposeDataBase.js:
export async function exportarWHP(skip = 0, limit = 500) {
    const limitNum = Math.min(Math.max(1, limit), 1000);
    const skipNum = Math.max(0, skip);

    let query = wixData.query("WHP")
        .skip(skipNum)
        .limit(limitNum);

    const results = await query.find();

    const items = results.items.map(item => ({
        _id: item._id,
        userId: item.userId,
        nombre: item.nombre || null,
        stopBot: item.stopBot === true,
        _createdDate: item._createdDate,
        _updatedDate: item._updatedDate
    }));

    return {
        success: true,
        items: items,
        count: items.length,
        totalCount: results.totalCount,
        skip: skipNum,
        hasMore: (skipNum + items.length) < results.totalCount,
        nextSkip: skipNum + items.length
    };
}

// En backend/http-functions.js:
export async function get_exportarWHP(request) {
    const { skip = '0', limit = '500' } = request.query;
    const skipNum = parseInt(skip, 10);
    const limitNum = parseInt(limit, 10);

    const resultado = await exportarWHP(skipNum, limitNum);

    return {
        body: resultado,
        headers: { "Content-Type": "application/json" },
        status: 200
    };
}

ğŸš€ DespuÃ©s de agregar el cÃ³digo: PUBLICA TU SITIO WIX

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  PASO 2: PROBAR ENDPOINT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Una vez publicado Wix, prueba que el endpoint funciona:

curl "https://www.bsl.com.co/_functions/exportarWHP?skip=0&limit=10"

âœ… Respuesta esperada:
{
  "success": true,
  "items": [...],
  "count": 10,
  "totalCount": 34000,
  ...
}

âŒ Si obtienes error 404:
   â†’ El endpoint no fue agregado o no se publicÃ³ Wix
   â†’ Vuelve al PASO 1

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  PASO 3: EJECUTAR MIGRACIÃ“N
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

3.1 MODO PRUEBA (Primero ejecuta esto):
----------------------------------------
cd /Users/danieltalero/BOTV3/bot-v3
node migracion-whp.js --test

Esto procesa solo 1000 registros para verificar que todo funciona.

âœ… Si sale todo bien:
   âœ“ VerÃ¡s estadÃ­sticas de migraciÃ³n
   âœ“ Conteo de registros insertados
   âœ“ Sin errores

âŒ Si hay errores:
   â†’ Verifica que el endpoint de Wix funciona (PASO 2)
   â†’ Revisa los logs del script
   â†’ Consulta MIGRACION_WHP.md secciÃ³n "Troubleshooting"


3.2 MIGRACIÃ“N COMPLETA:
-----------------------
node migracion-whp.js

â±ï¸ DuraciÃ³n estimada: 5-10 minutos (34,000 registros)

El script:
- Procesa en lotes de 500 registros
- Reintentos automÃ¡ticos si falla
- Pausa de 3 segundos entre lotes
- Muestra progreso en tiempo real

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  PASO 4: VERIFICAR RESULTADOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

node migracion-whp.js --verify

Esto muestra:
âœ“ Total de registros en Wix WHP
âœ“ Total de registros en PostgreSQL
âœ“ Registros con stopBot=true
âœ“ Muestra de Ãºltimos 10 registros

Si los conteos NO coinciden:
â†’ Ejecuta de nuevo: node migracion-whp.js
â†’ El script usa UPSERT, no duplicarÃ¡ datos

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  MAPEO DE DATOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Campo Wix          â†’  Campo PostgreSQL
-----------------     ---------------------
userId             â†’  celular (clave Ãºnica)
nombre             â†’  nombre_paciente
stopBot            â†’  stopBot
_id                â†’  wix_whp_id
_createdDate       â†’  fecha_inicio
_updatedDate       â†’  fecha_ultima_actividad

Campos adicionales en PostgreSQL:
- estado: 'migrada'
- canal: 'bot'
- bot_activo: !stopBot (inverso de stopBot)
- origen: 'WIX'

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  OPCIONES DEL SCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

--test          Solo procesar 1000 registros (modo prueba)
--dry-run       Simular sin hacer cambios reales
--verify        Solo verificar conteos
--skip=N        Continuar desde registro N (si se interrumpiÃ³)

Ejemplos:
---------
node migracion-whp.js --test                # Modo prueba
node migracion-whp.js --dry-run             # Ver quÃ© harÃ­a
node migracion-whp.js                       # MigraciÃ³n completa
node migracion-whp.js --verify              # Verificar despuÃ©s
node migracion-whp.js --skip=10000          # Continuar desde 10000

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  TROUBLESHOOTING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âŒ Error: "ENOTFOUND" o "404 Not Found"
   SoluciÃ³n:
   â†’ Verifica que el endpoint existe en Wix
   â†’ Prueba con curl (PASO 2)
   â†’ AsegÃºrate de haber publicado Wix

âŒ Error: "504 Gateway Timeout"
   SoluciÃ³n:
   â†’ El endpoint de Wix tarda mucho
   â†’ Edita migracion-whp.js lÃ­nea 36: cambia BATCH_SIZE a 200
   â†’ El script reintenta automÃ¡ticamente

âŒ Error: "duplicate key value"
   SoluciÃ³n:
   â†’ No deberÃ­a pasar con UPSERT
   â†’ El script actualiza registros existentes
   â†’ Si persiste, contacta soporte

âŒ Faltan registros despuÃ©s de migraciÃ³n
   SoluciÃ³n:
   â†’ Ejecuta: node migracion-whp.js --verify
   â†’ Si faltan registros, ejecuta de nuevo: node migracion-whp.js
   â†’ El script NO duplica, usa UPSERT

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  VERIFICACIÃ“N POST-MIGRACIÃ“N
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Consultas SQL Ãºtiles:

-- Conteo total
SELECT COUNT(*) FROM conversaciones_whatsapp;

-- Registros con stopBot=true
SELECT COUNT(*) FROM conversaciones_whatsapp WHERE "stopBot" = true;

-- Registros migrados desde Wix
SELECT COUNT(*) FROM conversaciones_whatsapp WHERE origen = 'WIX';

-- Ãšltimos 10 registros
SELECT celular, nombre_paciente, "stopBot", estado
FROM conversaciones_whatsapp
ORDER BY fecha_ultima_actividad DESC
LIMIT 10;

-- Verificar duplicados (no deberÃ­a haber)
SELECT celular, COUNT(*) as count
FROM conversaciones_whatsapp
GROUP BY celular
HAVING COUNT(*) > 1;

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  IMPORTANTE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âš ï¸ NOTAS CRÃTICAS:

1. NO SE MIGRAN MENSAJES
   Solo se transfieren: celular, nombre y stopBot
   Los mensajes permanecen en Wix (colecciÃ³n WHP)

2. stopBot ES CRÃTICO
   Este campo controla si el bot responde o no
   La migraciÃ³n preserva este estado

3. UPSERT POR CELULAR
   Si un celular ya existe, se actualiza su stopBot
   NO se crean duplicados

4. EJECUCIÃ“N SEGURA
   Puedes ejecutar el script mÃºltiples veces
   Usa UPSERT (INSERT or UPDATE), no duplica datos

5. SIN RIESGO
   La migraciÃ³n NO modifica ni elimina datos en Wix
   Solo lee de Wix y escribe/actualiza en PostgreSQL

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  RESUMEN DE PASOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â–¡ 1. Agregar cÃ³digo a Wix (backend/exposeDataBase.js y http-functions.js)
â–¡ 2. Publicar sitio Wix
â–¡ 3. Probar endpoint: curl "https://www.bsl.com.co/_functions/exportarWHP?skip=0&limit=10"
â–¡ 4. Ejecutar modo prueba: node migracion-whp.js --test
â–¡ 5. Ejecutar migraciÃ³n completa: node migracion-whp.js
â–¡ 6. Verificar resultados: node migracion-whp.js --verify
â–¡ 7. Verificar con SQL (queries arriba)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“– DOCUMENTACIÃ“N COMPLETA: Ver MIGRACION_WHP.md

âœ… Â¡Listo para migrar 34,000 registros!
